name: PowerShell Syntax Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  powershell-syntax-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PowerShell Core (when running under ACT)
      if: ${{ env.ACT }}
      run: |
        # Install PowerShell on Ubuntu if not available
        if ! command -v pwsh &> /dev/null; then
          # Update the list of packages
          sudo apt-get update

          # Install pre-requisite packages
          sudo apt-get install -y wget apt-transport-https software-properties-common

          # Get the version of Ubuntu
          source /etc/os-release

          # Download the Microsoft repository keys
          wget -q https://packages.microsoft.com/config/ubuntu/$VERSION_ID/packages-microsoft-prod.deb

          # Register the Microsoft repository keys
          sudo dpkg -i packages-microsoft-prod.deb

          # Delete the Microsoft repository keys file
          rm packages-microsoft-prod.deb

          # Update the list of packages after we added packages.microsoft.com
          sudo apt-get update

          # Install PowerShell
          sudo apt-get install -y powershell
        fi

    - name: Find and check PowerShell scripts
      shell: pwsh
      run: |
        Write-Host "Finding PowerShell scripts in the repository..."
        $scripts = Get-ChildItem -Path . -Recurse -Include "*.ps1" | Where-Object { $_.FullName -notlike "*\.github*" }

        foreach ($script in $scripts) {
          if (Test-Path $script.FullName) {
            Write-Host "Checking syntax for: $($script.FullName)"
            $content = Get-Content -Path $script.FullName -Raw
            $errors = $null
            $tokens = [System.Management.Automation.PSParser]::Tokenize($content, [ref]$errors)

            if ($errors.Count -gt 0) {
              Write-Host "Syntax errors found in $($script.FullName):"
              foreach ($error in $errors) {
                Write-Host "Line $($error.StartLine): $($error.Message)"
              }
              exit 1
            } else {
              Write-Host "No syntax errors found in $($script.FullName)"
            }
          }
        }
