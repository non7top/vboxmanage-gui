name: PowerShell Linting

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  powershell-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Set-PSRepository PSGallery -InstallationPolicy Trusted
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        # Find all PowerShell scripts in the repository
        $scripts = Get-ChildItem -Path . -Recurse -Include '*.ps1' | Where-Object { $_.FullName -notlike '*\.github*' }

        # Initialize results
        $results = @()

        # Analyze each script
        foreach ($script in $scripts) {
          Write-Host "Analyzing: $($script.FullName)"
          $analysis = Invoke-ScriptAnalyzer -Path $script.FullName -Severity @('Error', 'Warning')
          if ($analysis) {
            $results += $analysis
          }
        }

        # Output results
        if ($results.Count -gt 0) {
          Write-Host 'PSScriptAnalyzer found issues:'
          $results | Format-Table -AutoSize
          exit 1
        } else {
          Write-Host 'PSScriptAnalyzer found no issues.'
        }
