name: PowerShell Syntax Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  powershell-syntax-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PowerShell
      uses: dcarbone/install-powershell-action@v1.0.0

    - name: Find PowerShell scripts
      id: find-scripts
      run: |
        echo "Finding PowerShell scripts in the repository..."
        scripts=$(find . -name "*.ps1" -not -path "./.github/*" | head -20)
        echo "scripts<<EOF" >> $GITHUB_OUTPUT
        echo "$scripts" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Check PowerShell syntax
      run: |
        set -e
        while IFS= read -r script; do
          if [[ -n "$script" ]]; then
            echo "Checking syntax for: $script"
            pwsh -Command "Test-Path -Path '$script' -PathType Leaf" 2>/dev/null || { echo "File does not exist: $script"; exit 1; }
            pwsh -Command "& {
              try {
                $contents = Get-Content -Path '$script' -Raw
                $errors = @()
                $null = [System.Management.Automation.PSParser]::Tokenize($contents, [ref]$errors)
                if ($errors.Count -gt 0) {
                  Write-Host 'Syntax errors found in $script:'
                  foreach ($error in $errors) {
                    Write-Host \"Line $($error.StartLine): $(\$error.Message)\"
                  }
                  exit 1
                } else {
                  Write-Host 'No syntax errors found in $script'
                }
              } catch {
                Write-Host \"Error parsing $script : $($_.Exception.Message)\"
                exit 1
              }
            }"
          fi
        done <<< "$(echo "${{ steps.find-scripts.outputs.scripts }}" | tr '\n' '\0' | xargs -0 -n 1)"
