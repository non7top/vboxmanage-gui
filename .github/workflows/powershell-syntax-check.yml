name: PowerShell Syntax Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  powershell-syntax-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find and check PowerShell scripts
      shell: pwsh
      run: |
        Write-Host "Finding PowerShell scripts in the repository..."
        $scripts = Get-ChildItem -Path . -Recurse -Include "*.ps1" | Where-Object { $_.FullName -notlike "*\.github*" }

        foreach ($script in $scripts) {
          if (Test-Path $script.FullName) {
            Write-Host "Checking syntax for: $($script.FullName)"
            $content = Get-Content -Path $script.FullName -Raw
            $errors = $null
            $tokens = [System.Management.Automation.PSParser]::Tokenize($content, [ref]$errors)

            if ($errors.Count -gt 0) {
              Write-Host "Syntax errors found in $($script.FullName):"
              foreach ($error in $errors) {
                Write-Host "Line $($error.StartLine): $($error.Message)"
              }
              exit 1
            } else {
              Write-Host "No syntax errors found in $($script.FullName)"
            }
          }
        }
