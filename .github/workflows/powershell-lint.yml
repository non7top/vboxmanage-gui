name: PowerShell Linting

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  powershell-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PowerShell Core (when running under ACT)
      if: ${{ env.ACT }}
      run: |
        # Install PowerShell on Ubuntu if not available
        if ! command -v pwsh &> /dev/null; then
          # Update the list of packages
          sudo apt-get update

          # Install pre-requisite packages
          sudo apt-get install -y wget apt-transport-https software-properties-common

          # Get the version of Ubuntu
          source /etc/os-release

          # Download the Microsoft repository keys
          wget -q https://packages.microsoft.com/config/ubuntu/$VERSION_ID/packages-microsoft-prod.deb

          # Register the Microsoft repository keys
          sudo dpkg -i packages-microsoft-prod.deb

          # Delete the Microsoft repository keys file
          rm packages-microsoft-prod.deb

          # Update the list of packages after we added packages.microsoft.com
          sudo apt-get update

          # Install PowerShell
          sudo apt-get install -y powershell
        fi

    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Set-PSRepository PSGallery -InstallationPolicy Trusted
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        # Find all PowerShell scripts in the repository
        $scripts = Get-ChildItem -Path . -Recurse -Include '*.ps1' | Where-Object { $_.FullName -notlike '*\.github*' }

        # Initialize results
        $results = @()

        # Analyze each script
        foreach ($script in $scripts) {
          Write-Host "Analyzing: $($script.FullName)"
          $analysis = Invoke-ScriptAnalyzer -Path $script.FullName -Severity @('Error', 'Warning')
          if ($analysis) {
            $results += $analysis
          }
        }

        # Output results
        if ($results.Count -gt 0) {
          Write-Host 'PSScriptAnalyzer found issues:'
          $results | Format-Table -AutoSize
          exit 1
        } else {
          Write-Host 'PSScriptAnalyzer found no issues.'
        }
