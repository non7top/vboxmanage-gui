name: PowerShell Quality Checks

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  powershell-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PowerShell Core (when running under ACT)
      if: ${{ env.ACT }}
      run: |
        # Install PowerShell on Ubuntu if not available
        if ! command -v pwsh &> /dev/null; then
          # Update the list of packages
          sudo apt-get update

          # Install pre-requisite packages
          sudo apt-get install -y wget apt-transport-https software-properties-common

          # Get the version of Ubuntu
          source /etc/os-release

          # Download the Microsoft repository keys
          wget -q https://packages.microsoft.com/config/ubuntu/$VERSION_ID/packages-microsoft-prod.deb

          # Register the Microsoft repository keys
          sudo dpkg -i packages-microsoft-prod.deb

          # Delete the Microsoft repository keys file
          rm packages-microsoft-prod.deb

          # Update the list of packages after we added packages.microsoft.com
          sudo apt-get update

          # Install PowerShell
          sudo apt-get install -y powershell
        fi

    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Set-PSRepository PSGallery -InstallationPolicy Trusted
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

    - name: Check PowerShell syntax and run PSScriptAnalyzer
      shell: pwsh
      run: |
        # Find all PowerShell scripts in the repository
        $scripts = Get-ChildItem -Path . -Recurse -Include '*.ps1' | Where-Object { $_.FullName -notlike '*\.github*' }

        # Initialize results
        $totalErrors = 0

        # Check syntax and run PSScriptAnalyzer for each script
        foreach ($script in $scripts) {
          Write-Host "Processing: $($script.FullName)"

          # Check syntax
          $content = Get-Content -Path $script.FullName -Raw
          $parseErrors = $null
          $null = [System.Management.Automation.PSParser]::Tokenize($content, [ref]$parseErrors)

          if ($parseErrors.Count -gt 0) {
            Write-Host "Syntax errors found in $($script.FullName):" -ForegroundColor Red
            foreach ($error in $parseErrors) {
              Write-Host "Line $($error.StartLine): $($error.Message)" -ForegroundColor Red
            }
            $totalErrors++
          } else {
            Write-Host "No syntax errors found in $($script.FullName)" -ForegroundColor Green
          }

          # Run PSScriptAnalyzer
          $analysis = Invoke-ScriptAnalyzer -Path $script.FullName -Severity @('Error', 'Warning')
          if ($analysis) {
            Write-Host "PSScriptAnalyzer issues found in $($script.FullName):" -ForegroundColor Yellow
            foreach ($item in $analysis) {
              Write-Host "[$($item.Severity)] $($item.RuleName): $($item.Message) at line $($item.Line)" -ForegroundColor Yellow
            }
            $totalErrors += $analysis.Count
          } else {
            Write-Host "No PSScriptAnalyzer issues found in $($script.FullName)" -ForegroundColor Green
          }
        }

        # Output final results
        if ($totalErrors -gt 0) {
          Write-Host "Total issues found: $totalErrors" -ForegroundColor Red
          exit 1
        } else {
          Write-Host "All PowerShell scripts passed syntax and linting checks!" -ForegroundColor Green
        }
